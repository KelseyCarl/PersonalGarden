<style>
  .detailtable_otherin {
  	border:0.5px solid  #b8d0d6;
  	/*margin-left:12%;*/
  	margin-top:5px;
  }
	.detailtable_otherin td{
		width:80px!important;
		height:30px;
		border-right:1px solid #C0C0C0!important;
		border-bottom:1px solid #C0C0C0!important;
		border-top:1px solid #fff !important;
		border-left:1px solid #fff !important;
		border:1px solid #cococo;
		text-align: center;
	}
	.disable{
	width: 100%;
	cursor:pointer;
	border:none !important;
	background: none !important;
	margin-left: -3px!important;
	text-align: center;
	height: 100%;
}
.caution{
	color: red;
	margin-top: 10px;
}
</style>
<script src="js/publicjs/common.js"></script>
<script type="application/javascript">
$(function(){
	table_flag=false;
	check_justfloat();
var tableContent_oi=get_detail(detaili,detailj);
$(".detailtable_otherin").append(tableContent_oi);
if(title=="资金调成总"||title=="资金调经营部"){
	var palert='<p class="caution">注：若是【资金调成总】，请在对方部门栏填“成总合计”</p>';
	$("#printset").append(palert);
}
$("#detailsub").click(function(){
save_detail(detaili,detailj);
$.pdialog.closeCurrent(); 
});
if(title=="经营费用"||title=="车辆费用")
$(".detailtable_otherin").css("margin-left",(700-80*col)/2+"px");
else
$(".detailtable_otherin,.caution").css("margin-left",(539-80*col)/2+"px");
$(".justfloat").each(function(){
	$(this).keyup(function(){
		checkFloat($(this));
	});//keyup
});//each
})//ready
		$("#deleterow").click(function(){
       var temp=row-1;
       if(temp){
		$(".detailtable_otherin tbody").children('tr[name='+'\"'+temp+'\"]').remove();
       row--;}
	});
	$("#addrow").click(function(){
   var value=add_tvalue(col,row);
       $(".detailtable_otherin").append(value);
	    	row++;
	});
	function edit_datail(obj){
		obj.children().select();
	  obj.css("border","1px solid red");
};
function finset(obj){
	obj.parent().css({
	"border":"1px solid #C0C0C0",
	"border-right":"1px solid #C0C0C0",
	"border-bottom": "1px solid #c0c0c0",
	"border-top":"1px solid #fff",
	"border-left":"1px solid #fff"});
	var i=parseInt(obj.parent().attr("name"));
	if(i>=justfloat_index&&i<justfloat_index+num){
	obj.val(obj.val().replace(/\.$/,"")); 
      obj.val(obj.val().replace(/^\-$/g,0));
     var patrn=/^\-?\d+.?\d*$/g;
	   var result=patrn.exec(obj.val());
	   if(!result){
	   	if(obj.val()!="") {
	   	alert("输入格式不对!");
      obj.focus().select();
	   	}
	   }
}}
	function add_tvalue(colspan,time){//明细表生成colspan列的新增行
		if(time>0)
var addvalue='<tr  name='+'\"'+time+'\">';
var child_datax=eval(data_inputds.data[detaili].tr[detailj].child.child_data[0]);
 	var class_flag=false;
 	$.each(child_datax,function(m){
 		if(m=="class") class_flag=true;
 	})
		for(var i=0;i<colspan;i++){
					if(class_flag&&i==1){
						addvalue=addvalue+'<td style="border:1px solid gray" name=\"'+i+'\" onclick="edit_datail($(this))"><select onblur="finset($(this))"   class="disable"  value=""><option value=""></option><option value="0">防盗门</option><option value="1">三代机</option><option value="2">地面波</option></select></td>';
					}
					else{
						if(i>=justfloat_index&&i<justfloat_index+num)
	 			{
						addvalue=addvalue+'<td style="border:1px solid gray" name=\"'+i+'\" onclick="edit_datail($(this))"><input type="text" class="disable" onblur="finset($(this))" onkeyup="checkFloat($(this))"   value=""\/></td>';
	 				
	 			}
	 			else{
	 					addvalue=addvalue+'<td  style="border:1px solid gray" name=\"'+i+'\" onclick="edit_datail($(this))"><input type="text" class="disable" onblur="finset($(this))"   value=""\/></td>';
	 			}

					}
		}
		addvalue=addvalue+'</tr>';
		return addvalue;
	};
	function save_detail(i,j){
			var detail=eval(data_inputds.data[i].tr[j].child.child_data);
			//child的数据保存开始
					sum=[0,0,0];
				if(title=="新增"||title=="收回欠款"||title=="车辆费用"||title=="经营费用"||title=="资金调成总"||title=="资金调经营部"){
				 var arrears;
				 var sum_takeb=[0,0,0];
				}
				
			for(var m=0;m<row;m++){//遍历明细表格一行
				if(m==0){//遍历第一行
						var detaildata=new Object();
						detail.length=0;
					for(var n=0;n<col;n++){
						
						var temp_n=n+1;
				var val_temp=$('.detailtable_otherin tr[name='+m+'] td:nth-child('+temp_n+')').text();
				     val_temp=val_temp.replace(/\s*/g,'');
				     if(!val_temp||val_temp==NaN){val_temp=0;}//如果该项为空就赋值为0
						detaildata[detail_label[n]]=val_temp;
					}
					detail.push(detaildata);
					}
			 else{

			 		var detaildata=new Object();
      if($('.detailtable_otherin tr[name='+m+'] td:nth-child(1)').children(".disable").val()=="")
continue;
			 		for(var n=0;n<col;n++){//遍历明细表格一列
			    var attr_temp=detail_label[n];//取出属性名
			    var temp_n=n+1;
          var  val_temp=$('.detailtable_otherin tr[name='+m+'] td:nth-child('+temp_n+')').children(".disable").val();
           detaildata[attr_temp]=val_temp;
           //开始获得和的数组
  if (title == "资金调成总" || title == "资金调经营部") {
	       val_temp = parseFloat($('.detailtable_otherin tr[name=' + m + '] td:nth-child(4)').children(".disable").val());
	        if(!val_temp||val_temp==NaN){val_temp=0;}//如果该项为空就赋值为0
	      if ($('.detailtable_otherin tr[name=' + m + '] td:nth-child(1)').children(".disable").val() == "成总合计"&&n>2) {
		     sum_takeb[0] = sum_takeb[0] + val_temp;
}
      else {
		    if(n>2) {
		    	sum[1] = sum[1] + val_temp;
		    }
	}
}
  else if(( title == "代收款" || title == "代支其他部门")&& n > 0){
	val_temp = parseFloat($('.detailtable_otherin tr[name=' + m + '] td:nth-child(2)').children(".disable").val());
	 if(!val_temp||val_temp==NaN){val_temp=0;}//如果该项为空就赋值为0
	sum[2] = sum[2] + val_temp;
  }
  else if ((title == "经营部资金调入" || title == "代支采购货款" || title == "代收款" || title == "代支其他部门") && n > 0) {
	val_temp = parseFloat($('.detailtable_otherin tr[name=' + m + '] td:nth-child(2)').children(".disable").val());
	 if(!val_temp||val_temp==NaN){val_temp=0;}//如果该项为空就赋值为0
	var temp_col = get_location();
	sum[temp_col] = sum[temp_col] + val_temp;
	
}
 else if ((title == "新增" || title == "收回欠款" )&&n) {
	   val_temp = parseFloat(val_temp);
	 if(!val_temp||val_temp==NaN){val_temp=0;}//如果该项为空就赋值为0
	   
 	 if(n==1){
           	  arrears=val_temp;
           }
	   if (n == 3) {
		      sum_takeb[arrears] = sum_takeb[arrears] + val_temp;
	}
	   if (n == 2) {
		      sum[arrears] = sum[arrears] + val_temp;
	   }
} 
 else if (title == "车辆费用" || title == "经营费用") {
	    var pro_clas = $('.detailtable_otherin tr[name=' + m + '] td:nth-child(1)').children(".disable").val();
       pro_clas=pro_clas.replace(/\s*/g,'');
       arrears = n - 2;
	      val_temp = parseFloat(val_temp);
	 if(!val_temp||val_temp==NaN){val_temp=0;}//如果该项为空就赋值为0
	      
	   if (pro_clas == "经营费") {
	   	if(arrears >=0)
		sum_takeb[arrears] = sum_takeb[arrears] + val_temp;
	}  
	else{
		sum[arrears] = sum[arrears] + val_temp;
	}

} 
else { //获取和值
		val_temp=parseFloat(val_temp);
	 if(!val_temp||val_temp==NaN){val_temp=0;}//如果该项为空就赋值为0
		sum[n - 1] = sum[n - 1] + val_temp;
	
}
};//for n
			 		detail.push(detaildata);
			 }//else
			 
			}//for m
			//循环结束，开始保存外表的data和text值
		if(title=="新增"||title=="收回欠款"||title=="车辆费用"||title=="经营费用"||title=="资金调成总"||title=="资金调经营部"){
			findin_data_inputds();
			 var	data_takeb=eval(data_inputds.data[i].tr);
			 var  data_add=eval(data_inputds.data[addi].tr);
			 for(var outi=0;outi<sum.length;outi++){
        var temp_tdname=parseInt(j)+outi+1;
        var temp_tdnameadd=parseInt(addj)+outi+1;
        data_takeb[temp_tdname].value=sum_takeb[outi];
        data_add[temp_tdnameadd].value=sum[outi];
         var temp_num=4+parseInt(outi);	
    $('#rendrTable_inputds table  tr[name='+i+'] td:nth-child('+temp_num+')').text(sum_takeb[outi]);
    $('#rendrTable_inputds table  tr[name='+addi+'] td:nth-child('+temp_num+')').text(sum[outi]);
      }//for sum and sum_takeb 
			 }//else if
	else{

      var	dataxrow=eval(data_inputds.data[i].tr);
      for(var outi=0;outi<sum.length;outi++){
        var temp_tdname=parseInt(j)+outi+1;
        dataxrow[temp_tdname].value=sum[outi];
         var temp_num=4+parseInt(outi);
 $('#rendrTable_inputds table  tr[name='+i+'] td:nth-child('+temp_num+')').text(sum[outi]);
      }}
	};
	function get_detail(i,j)	{
	 var tbody='';
	 detail_label=new Array();
	var detail=eval(data_inputds.data[i].tr[j].child.child_data);
	 for( row=0;row<detail.length;row++){
	 	 tbody=tbody+'<tr name='+'\"'+row+'\">';
	 	 	 col=0;
	 	$.each(detail[row],function(m){
	 		if(row==0){
	 			detail_label[col]=m;
	 			tbody=tbody+'<td name=\"'+col+'\">'+detail[row][m]+'</td>';
	 		}
	 		else{
	 			detail_label[col]=m;
	 			if(m=="class") {
	 				tbody=tbody+'<td name=\"'+col+'\" onclick="edit_datail($(this))"><select onblur="finset($(this))" class="disable" value=\"'+detail[row][m]+'\">';
	 			  if(detail[row][m]==0)tbody=tbody+'<option value="0" selected="selected">防盗门</option><option value="1">三代机</option><option value="2">地面波</option>';
	 				if(detail[row][m]==1)tbody=tbody+'<option value="0">防盗门</option><option value="1" selected="selected">三代机</option><option value="2">地面波</option>';
	 				if(detail[row][m]==2)tbody=tbody+'<option value="0">防盗门</option><option value="1">三代机</option><option value="2" selected="selected">地面波</option>';
	 			  tbody=tbody+'</select></td>';
	 			}
	 			else {
	 				if(col>=justfloat_index&&col<justfloat_index+num)
	 			{
	 			tbody=tbody+'<td name=\"'+col+'\" onclick="edit_datail($(this))"><input type="text" onblur="finset($(this))" class="disable" value=\"'+detail[row][m]+'\" onkeyup="checkFloat($(this))"\/></td>';
	 			}
	 			else{
	 					 			tbody=tbody+'<td name=\"'+col+'\" onclick="edit_datail($(this))"><input type="text" onblur="finset($(this))" class="disable" value=\"'+detail[row][m]+'\"\/></td>';
	 			}
	 			}
	 			}
	 		col=col+1;
	 	});
	 	tbody=tbody+'</tr>';
	 }
	 	return tbody;
	 }
	function findin_data_inputds(){
		if(title=="新增"||title=="收回欠款")
         var str="新增";
    else if(title=="车辆费用"||title=="经营费用")var str="车辆费用";
    else var str="资金调经营部";
		for( var findi=0;findi<data_inputds.data.length;findi++){
			for(var  findj=0;findj<data_inputds.data[findi].tr.length;findj++){
				if(data_inputds.data[findi].tr[findj].value==str){
					  addi=findi;
					  addj=findj;
				}}};
	}
	function get_location(){
		if(title=="经营部资金调入"||title=="代支采购货款") return a=0;
		if(title=="代收款"||title=="代支其他部门") return a=1;
	}
	function check_justfloat(){//给所有输入数字的input框加上class="justfloat",startnum是遍历明细表的起始位置，time是遍历的行数
		if(title=="收回欠款"||title=="新增"||title=="车辆费用"||title=="经营费用"){
			justfloat_index=2;
			num=2;
		}
		else if(title == "代收款" || title == "代支其他部门"||title=="代支采购货款"||title=="经营部资金调入") {
			justfloat_index=1;
			num=1;
		}
		else if(title=="资金调成总"||title=="资金调经营部"){
			justfloat_index=3;
			num=1;
		}
		else{
			justfloat_index=1;
			num=2
		}
	}
</script>
<div class="pageContent" id="printset" layoutH=30>
    <table class="detailtable_otherin" border="1">
    </table>
</div>
		<div class="formBar">
		<ul>
			<li><div class="button" style="margin-right:5px ;" id="addrow"><div class="buttonContent"><button type="button">增加记录</button></div></div></li>
			<li><div class="button" style="margin-right:30px"><div class="buttonContent" id="deleterow"><button type="button">删除列行</button></div></div></li>
			<li><div class="button" id="detailsub"><div class="buttonContent"><button type="button">提交</button></div></div></li>
			<li><div class="button"><div class="buttonContent"><button type="button" class="close">取消</button></div></div></li></ul>
		</div>
			
		