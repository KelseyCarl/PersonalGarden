<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>个人设置</title>
    <link rel="stylesheet" href="../../css/foundation.6.3.0.css" />
    <link rel="stylesheet" href="../../layer/skin/default/layer.css">
    <link rel="stylesheet" href="https://static.runoob.com/assets/foundation-icons/foundation-icons.css">
    <link rel="stylesheet" href="../../css/app.css" />
    <!--<link rel="stylesheet" href="../../css/center.css" />-->
    <style type="text/css">
        .container{
            width: 80%;
            margin: 20px auto;
        }
        .title-top{
            border-bottom: 1px solid #e8e6e8;
            /*text-align: center;*/
            background: #06c673;
            color: #fff;
            padding: 10px;
        }
        .title-top h5{
            font-size: 16px;
            font-weight: bold;
            height: 20px;
            line-height: 20px;
            margin-top: 2px;
            margin-left: -30px;
        }
        .top-6{
            margin-top: 6px;
        }
      .title-top .save{
        color: #fff;
      }
      .change_head{
        background: #fff;
        /*margin-top: 20px;*/
        /*border:1px solid red;*/
        padding: 4px;
        border-bottom: 1px solid #e8e6e8;
      }
      .change_head .first_p{
        font-size: 14px;
        margin-top: 23%;
        /*font-family: sans-serif,,"微软雅黑";*/
        font-family:"Microsoft YaHei","微软雅黑";
      }
      .change_head .head_img{
        border-radius: 40px;
        border:1px solid #fff;
        height: 80px;
        margin-right: 20px;

      }
      .change_head .arrow_img{
        width: 20px;
        height: 20px;
        margin-top: 60%;
      }
       .change_head .second_p{
        margin-right: 30px;
        margin-top: 15%;
        font-size: 12px;
        color: #999;
      }
      .infor{
          /*width: 100px;*/
          /*border:0;*/
          /*border-bottom:1px solid #eee;*/
          /*background:transparent;*/
          margin: 10px auto;
          color: #999;
          font-size: 14px;
          /*padding: 20px 15px;*/
      }
    </style>
  </head>
  <body>
	<div class="">
    	<div class="row title-top">
          <div class="small-2 columns top-6">
            <a href="javascript:window.history.back()"><i class="fi-arrow-left float-left"></i></a>
          </div>
      		<div class="small-7 columns top-6">
                <h5 class="text-center">资料完善</h5>
      	    </div>
          <div class="small-3 columns top-6">
            <a href="" class="save float-right" id="save">保存</a>
          </div>
    	</div>
      <div class="" style="background: #eee;height: auto;">
          <div style="height: 20px;"></div>
          <div class="row change_head">
              <div class="small-4 columns" >
                <p class="first_p">更换头像</p>
              </div>
              <div class="small-6 columns">
                <img id="changehead" class="head_img float-right" src="http://placehold.it/100x100?text=我是头像" alt="head change" width="80">
              </div>
              <div class="small-2 columns">
                <img class="arrow_img" src="../../img/right_arrow.png" alt="arrow">
              </div>
          </div> 
          <div class="row change_head">
              <div class="small-4 columns" >
                <p class="first_p">昵称</p>
              </div>
              <div class="small-6 columns">
                  <input type="text" name="nickname" id="nickname1" class="infor hide"/>
                  <p class="second_p float-right" id="nickname2"></p>
              </div>
              <div class="small-2 columns">
                    <img class="arrow_img arrow_here1" src="../../img/right_arrow.png" alt="arrow">
              </div>
          </div> 
          <div class="row change_head">
              <div class="small-4 columns" >
                <p class="first_p">tel</p>
              </div>
              <div class="small-6 columns">
                  <input type="tel" name="telephone" id="tel1" class="infor hide"/>
                  <p class="second_p float-right" id="tel_num"></p>
                <!--<p class="second_p float-right" id="tel_num"></p>-->
              </div>
              <div class="small-2 columns">
                <img class="arrow_img arrow_here2" src="../../img/right_arrow.png" alt="arrow">
              </div>
          </div> 
          <div class="row change_head">
              <div class="small-4 columns" >
                <p class="first_p">收货地址</p>
              </div>
              <div class="small-6 columns">
                  <input type="text" name="addr" id="addr1" class="infor hide"/>
                  <p class="second_p float-right" id="address"></p>
                <!--<p class="second_p float-right" id="address">四川省成都市郫县红光镇西华大学</p>-->
              </div>
              <div class="small-2 columns">
                <img class="arrow_img arrow_here3" src="../../img/right_arrow.png" alt="arrow">
              </div>
          </div>

          <div style="height: 20px;"></div>
          <div class="row change_head">
              <div class="small-4 columns" >
                <p class="first_p">重置密码</p>
              </div>
              <div class="small-6 columns">
                <p class="second_p float-right"></p>
              </div>
              <div class="small-2 columns">
                <a href="resetpass.html"><img class="arrow_img" src="../../img/right_arrow.png" alt="arrow"></a>
              </div>
          </div>
      </div>
      <div class="container">
        <button type="button" id="logout" class="button success expanded">退出登录</button>
      </div>
	</div>

    <script src="../../js/vendor/jquery.js"></script>
    <script src="../../js/vendor/what-input.js"></script>
    <script src="../../js/vendor/foundation.6.3.0.js"></script>
    <script src="../../layer/layer.js"></script>
    <!--<script src="../../js/app.js"></script>-->
    <script>
//        URL = "http://localhost/PersonalGarden/index.php/Home/";
        URL = "http://192.111.111.221/PersonalGarden/index.php/App/";
        $(document).foundation();
//        var token = localStorage.getItem("log_status");//从本地缓存取得token数据
        //从cookie中获取token值
        var token = getCookie("token");
        console.log(token);
        $(function(){
            $("#logout").click(function(){
//				localStorage.clear();//清除全部保存的对象
//                localStorage.removeItem("log_status");
                window.location.href = "login.html";
            });

            $("#changehead").click(function(){
                window.location.href = "change_head.html";
            });
            //昵称的修改
            $(".arrow_here1").click(function(){
                $("#nickname1").removeClass("hide");//输入框出现
                $(".arrow_here1").addClass("hide");//箭头消失
                $("#nickname2").addClass("hide");//文本元素消失
            });
            $("#nickname1").blur(function(){
                $("#nickname1").addClass("hide");//失去焦点隐藏
                $("#nickname2").removeClass("hide");
                var put_val = $("#nickname1").val();
                if(put_val == null || put_val == undefined || put_val == ''){
                    $(".arrow_here1").removeClass("hide");
                    return;
                }
                $("#nickname2").text(put_val);
                $(".arrow_here1").removeClass("hide");
            });
            //电话号码的修改
            $(".arrow_here2").click(function(){
                $("#tel1").removeClass("hide");//输入框出现
                $(".arrow_here2").addClass("hide");//箭头消失
                $("#tel_num").addClass("hide");//文本元素消失
            });
            $("#tel1").blur(function(){
                $("#tel1").addClass("hide");//失去焦点隐藏
                $("#tel_num").removeClass("hide");
                var put_val = $("#tel1").val();
                if(put_val == null || put_val == undefined || put_val == ''){
                    $(".arrow_here1").removeClass("hide");
                    return;
                }
                $("#tel_num").text(put_val);
                $(".arrow_here2").removeClass("hide");
            });
            //收货地址的修改
            $(".arrow_here3").click(function(){
                $("#addr1").removeClass("hide");//输入框出现
                $(".arrow_here3").addClass("hide");//箭头消失
                $("#address").addClass("hide");//文本元素消失
            });
            $("#addr1").blur(function(){
                $("#addr1").addClass("hide");//失去焦点隐藏
                $("#address").removeClass("hide");
                var put_val = $("#addr1").val();
                if(put_val == null || put_val == undefined || put_val == ''){
                    $(".arrow_here1").removeClass("hide");
                    return;
                }
                $("#address").text(put_val);
                $(".arrow_here3").removeClass("hide");
            });
            getinfor();
//            if(token == null) {
//                layer.msg("请先登录！");
//                window.location.href = "login.html";
//            }
//            else {
//                getinfor();
//            }
            //点击保存将用户资料存入数据库中
            $("#save").click(function(){
                var nickname = $("#nickname2").text();
                var tel = $("#tel_num").text();
                var address = $("#address").text();
                if(tel != null){
                    var Data={
                        data:{
                            nickname:nickname,//在接口确定之后修改字段名称
                            tel:tel,
                            address:address
                        }
                    };
                    $.ajax({
                        type:"post",
                        url:URL+"Setting/save/token/"+token,
                        data:JSON.stringify(Data),
                        async:false,
                        dataType:'json',
                        success:function(data){
                            //信息输入正确的时候
                            if(data.resultcode==0){
                                console.log("resultmsg"+data.resultmsg);
                                setTimeout(function(){
                                    window.location.href = "user_center.html";
                                },1);
                            }
                            else{
                                layer.msg(data.resultmsg);
                            }
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown, data) {
                            layer.msg(errorThrown);
                        }
                    });
                }else{
                    layer.msg("电话号码不可为空");
                }
            });
        });

        function getinfor(){
            //获取用户信息
            $.get(URL+"Login/login/token/"+token, function(json) {
                if(json.resultcode == -2) {
                    layer.msg("token已失效，请重新登录！");
                    window.location.href = "login.html";
                }
                else {
                    console.log(json);
                    user_head = json.data.subitem[0].photo_url;//获取用户头像
                    nickname = json.data.subitem[0].nickname;//获取用户昵称
                    user_tel = json.data.subitem[0].user_phone;//获取用户电话
                    user_addr = json.data.subitem[0].user_addr;//获取用户收货地址
                    console.log(nickname);
                    if(user_tel){
                        $(".head_img").attr('src',user_head);
                        $("#nickname2").text(nickname);
                        $("#tel_num").text(user_tel);
                        $("#address").text(user_addr);
                    }
                }
            });
        }

        function getCookie(name)
        {
            var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");
            if(arr=document.cookie.match(reg))
                return unescape(arr[2]);
            else
                return null;
        }
    </script>
  </body>
</html>
